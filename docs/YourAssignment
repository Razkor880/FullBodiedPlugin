YourAssignment — FBHide v2 (Slot / Partition Hiding)
ASSIGNMENT DESCRIPTION
Intent

Extend FBHide from “hide everything” to selective body-part hiding, while preserving v1 behavior, reset guarantees, and backward compatibility.

Constraints

Checklist is the source of truth; follow in order and stop at checkpoints.

FBHide(true/false) must continue to work exactly as-is.

No new schedulers, threads, hooks, or background work.

Execution must piggyback on existing timeline / game-thread update flow.

Body-part hiding must not inherit from parent nodes (e.g., pelvis hidden while legs remain visible).

The primary universal mechanism is BSDismember partitions, not NiNode visibility.

Scope (this pass)

Add one new, explicit, testable INI command:

FBHideSlot(<slotNumber>, <bool>)

Implement slot hiding via:

RE::BSDismemberSkinInstance::UpdateDismemberPartition(slot, enable)

(exact symbol name must match CommonLib RE headers)

Track baseline and restore on reset using a best-effort, safety-first policy.

Out of Scope (this pass)

Named body-part aliases (Pelvis / UpperLeg / etc.) as primary interface.

Regex / substring shape filters.

Persisting hide state across arbitrary 3D reloads beyond existing best-effort reset behavior.

END OF ASSIGNMENT DESCRIPTION

CHECKLIST
PHASE 0 — BASELINE SAFETY (NO CODE CHANGES)

0.1 Build current main.

0.2 In-game verification:

FBHide(true) hides actor geometry.

Reset paths (PairEnd, PairedStop, CancelAndReset) restore both caster and target.

Checkpoint A:
Baseline behavior unchanged and stable.

PHASE 1 — DEFINE SLOT HIDING SURFACE (MINIMAL, UNIVERSAL)

1.1 Define the single new command:

FBHideSlot(slotNumber, true|false)


1.2 Slot definition (explicit, documented):

slotNumber is the BSDismember partition “Body Part” / SBP value.

This is NOT the biped slot from Armor UI (even if numbers often coincide).

Valid range policy:

StrictIni: accept only 0..255; reject negatives and out-of-range.

Non-strict: log once and ignore invalid values.

Checkpoint B:
Slot semantics and bounds are explicitly written down.

PHASE 2 — DATA MODEL EXTENSION (COMPILE-ONLY)

2.1 Extend FB::TimedCommand hide payload:

Add:

HideMode hideMode (default = All)

std::uint16_t hideSlot = 0 (ignored unless hideMode == Slot)

2.2 Defaults must preserve behavior:

Existing FBHide(true/false) must behave identically.

Checkpoint C:
Project builds; existing INIs unchanged.

PHASE 3 — FBConfig PARSING (UNAMBIGUOUS + BACKWARD COMPATIBLE)

Important: legacy v1 parser must not accidentally swallow new commands.

3.1 Tighten legacy hide parsing

Match only tokens that start with:

FBHide(

Accept arguments:

true / false / 1 / 0

Case sensitivity:

Case-sensitive matching (recommended and approved).

3.2 Add new parser for slot hiding

Match only:

FBHideSlot(

Parse:

slotNumber (int)

bool

Apply bounds policy (see PHASE 1.2).

3.3 Emit command

TimedCommand{
  kind = kHide,
  hideMode = Slot,
  hideSlot = <slot>,
  hide = <bool>
}


Note (explicit):

hide represents user intent.

Dismember API uses enable = !hide.

Checkpoint D:
Builds cleanly; old INIs unchanged; new token parses correctly.

STOP CONDITION:
If parsing cannot be made unambiguous without breaking legacy FBHide(true/false), stop and ask.

PHASE 4 — ACTORMANAGER DISPATCH (MECHANICAL)

4.1 Replace single hide call with dispatch:

If hideMode == All:

Call existing FBHide::ApplyHide(...)

If hideMode == Slot:

Call new FBHide::ApplyHideSlot(actor, slot, hide)

4.2 Reset wiring:

Ensure ResetActor is called for both caster and target.

Hard fail if either participant is omitted.

Checkpoint E:
Builds; v1 behavior unchanged.

PHASE 5 — FBHide v2 INTERNALS (BSDismember SLOT HIDING)
5.0 Baseline Restore Policy (LOCKED)

Policy 1 (preferred):

Capture actual baseline “enabled” state per (ShapeKey, slot).

Restore that value on reset.

Policy 2 (approved fallback):

Track only “touched (ShapeKey, slot) pairs”.

On reset, set enable = true for all touched pairs.

Rationale: baseline is almost always enabled; safety > historical fidelity.

5.1 Baseline storage

New internal store:

Key: (ShapeKey, slotNumber)

Value:

Policy 1: baseline enabled state

Policy 2: no value; touched-only

5.2 Traversal

Reuse v1 traversal:

Render geometry only (BSTriShape / NiGeometry)

Skip bones, helper nodes, non-render nodes.

Only attempt slot hiding on geometry with:

skinInstance that is RE::BSDismemberSkinInstance.

5.3 Apply slot hide

For each eligible geometry:

Call:

UpdateDismemberPartition(slot, enable)

Where:

hide == true → enable = false

hide == false → restore baseline (Policy 1) or enable = true (Policy 2)

5.4 Baseline capture rule

Capture baseline once per (ShapeKey, slot).

Never overwrite baseline on repeated calls.

5.5 Unsupported meshes

If no eligible BSDismemberSkinInstance found:

Do nothing.

Log once per actor per slot (guarded by logOps).

Do not fall back to whole-shape hiding in this pass.

Checkpoint F:
Builds; FBHideSlot produces observable changes on at least one partitioned mesh.

STOP CONDITION:
If neither Policy 1 nor Policy 2 can be implemented safely, stop and ask.

PHASE 6 — RESET INTEGRATION (BOTH MECHANISMS)

6.1 On reset:

Restore:

v1 shape hidden-flag baselines

v2 slot baselines (per policy)

Order does not matter.

6.2 After reset:

Clear all FBHide state for that actor.

6.3 Missing 3D on reset:

Clear state.

Log restore skipped (debug-only).

Rely on default visible on reload.

Checkpoint G:
Cancel/reset restores visibility and clears state.

PHASE 7 — TEST MATRIX (REQUIRED)

7.1 Regression

FBHide(true) → reset restores fully (caster + target).

7.2 Slot basics

FBHideSlot(slot, true) hides only that region.

FBHideSlot(slot, false) restores.

7.3 Pelvis vs legs

On a mesh with separate partitions:

Hide pelvis slot.

Legs remain visible.

7.4 Mid-timeline cancel

Slot hide fires.

Pair ends early.

Reset restores.

7.5 Cell transition

Slot hide → cell change → reset.

No CTD; restores when possible.

7.6 Mixed commands

FBHideSlot(slot,true)

then FBHide(true)

then reset

Result: both shape and slot baselines restored.

Checkpoint H:
All tests pass; no crashes; no regressions.

PHASE 8 — OPTIONAL QUALITY (ONLY IF GREEN)

8.1 Debug dump (debug-only)

Geometry count visited

BSDismember instances found

Slot numbers toggled

8.2 Documentation

Recommend numeric slots first.

Note name aliases may be added later.

DONE CONDITIONS

FBHide(true/false) unchanged and reliable.

FBHideSlot(slot,bool) works where BSDismember partitions exist.

No parent/child inheritance issues.

Reset restores both caster and target.
