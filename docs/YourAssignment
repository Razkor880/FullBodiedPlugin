YourAssignment – Tween Refactor (Revised Canon for Executor)

Authority and Scope

This document provides explicit, temporary execution instructions for the Tween Refactor task.
It is task-scoped and non-canonical, but authoritative for this refactor.

If instructions conflict, resolve in this order:

docs/architecture (once stable)

This document (YourAssignment)

docs/design_notes

This document may override defaults and workflows, but must not redefine architecture or external contracts.

Executor Role Definition

You are operating as an executor GPT.

Your responsibilities:

Implement the refactor exactly as described

Preserve existing behavior unless explicitly changed here

Keep changes scoped, readable, and reversible

Ask before making architectural changes beyond this assignment

Prefer minimal-diff refactors over rewrites

Treat existing stable systems as fragile unless instructed otherwise

You must not:

Invent new systems outside this scope

Change external contracts (INI grammar, event names, semantics)

Perform speculative or aesthetic refactors

Improve or clean up unrelated code

Introduce engine-level hooks or new update mechanisms

Project Invariants (Must Remain True)

Animations describe intent; code executes intent.

Timelines may originate from INI now and HKX annotations later.

Downstream runtime systems must not care about the source.

The animation start event is always named FBEvent.

FBEvent is authored in the paired animation clip trigger array.

Cancellation and reset semantics must remain unchanged.

All changes must be backward compatible with existing INI files.

High-Level Goal

Add optional tweening support for morph timeline commands while preserving the existing INI-driven pipeline, runtime behavior, and external contracts.

Tweening must:

Be optional

Default to current instant behavior

Distribute a command’s delta over time

Integrate cleanly with the existing ActorManager execution model

This refactor must also prepare (but not implement) future HKX timeline support.

Tween Execution Model (Authoritative Decision)

Tween stepping shall use a central tween runner thread owned by ActorManager.

This runner:

Is not an engine tick

Is not routed through SKSE update hooks

Is not frame-accurate

Ticks at a fixed cadence using sleep (for example 16–33ms)

Advances all active tweens in one place

There must NOT be:

One thread per tween

Engine update hooks

New scheduling systems

The runner must:

Be cancellable via the existing token mechanism

Exit cleanly when no tweens are active (or idle safely)

Dispatch all game-thread mutations via existing SKSE task mechanisms

Tween Semantics (Authoritative)

tweenSeconds represents the total duration over which a command’s declared delta is applied.

This means:

A morph command with value X applies exactly X total delta

Tweening controls how quickly that delta is reached

Faster tween = same result sooner

Slower tween = same result later

Implementation requirement:

Store totalDelta and appliedSoFar

Each tick applies (targetAtTime - appliedSoFar)

Never repeatedly re-base off current actor state

Sum of all steps must equal the declared delta (within float tolerance)

No absolute target morph values are introduced.

Data Model Changes (Minimal)

Extend the existing timed-command representation to include:

tweenSeconds (float, default 0.0)

tweenCurve (enum or identifier, default linear)

If tweenSeconds == 0:

Command follows the existing instant execution path

If tweenSeconds > 0:

Command is executed via the tween system

Do not:

Change command naming

Change existing fields

Add new command types

INI Parsing Changes

INI grammar must remain backward compatible.

Parsing updates:

Extend existing command parsing to optionally read tween parameters

Missing tween fields must default safely

Strict INI mode must reject malformed tween syntax

Non-strict mode must log and ignore invalid tween fields

No reformatting of existing INI files is required.

AnimationEvents Refactor Instruction

Legacy timeline parsing logic currently located in AnimationEvents shall be migrated into FBConfig.

After migration:

FBConfig is the sole owner of timeline parsing and validation

AnimationEvents acts only as an orchestration layer

AnimationEvents responsibilities:

Receive animation graph events

Filter for FBEvent and stop events

Resolve caster and target

Request timeline execution from ActorManager

Trigger cancel/reset on stop events

AnimationEvents must not:

Parse INI files

Own timeline data

Execute commands directly

Removal of AnimationEvents entirely is NOT required at this stage.

ActorManager Responsibilities (Post-Refactor)

ActorManager owns:

Timeline execution

Tween lifecycle management

Cancellation tokens

Reset behavior

Tracking of touched nodes and morphs

ActorManager must:

Route instant commands exactly as before

Route tweened commands through the central tween runner

Respect existing cancellation and reset semantics

Remain the single source of runtime truth

Future HKX Support (Stub Only)

Introduce an abstraction boundary (for example a TimelineProvider concept) such that:

INI timelines are provided via FBConfig

HKX timelines could be added later

Do NOT:

Parse HKX files

Load annotations

Change runtime behavior

Add feature flags

This is a structural preparation only.

Non-Goals (Explicit)

This refactor must NOT:

Redesign the scheduler

Introduce visibility tweening

Introduce absolute morph targets

Change event names

Change reset behavior

Change cancellation semantics

Touch unrelated legacy systems

Perform code cleanup unrelated to tweening or parsing migration

Success Criteria

The refactor is successful when:

Existing INI timelines behave identically with tweenSeconds = 0

Morph tweening works correctly over time

Cancellation mid-tween leaves no residual state

Reset behavior remains correct

AnimationEvents no longer parses timelines

FBConfig is the single parsing authority

No new engine hooks are introduced

End of YourAssignment
